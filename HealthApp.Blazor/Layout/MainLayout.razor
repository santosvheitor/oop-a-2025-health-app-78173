@inherits LayoutComponentBase
@inject CustomAuthStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@using HealthApp.Blazor.Auth
@using Microsoft.AspNetCore.Components.Authorization

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <!-- TOPO -->
        <div class="top-row px-4 d-flex justify-content-between align-items-center bg-light border-bottom">
            <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>

            <AuthorizeView>
                <Authorized Context="auth">
                    <div class="d-flex align-items-center">
                        <span class="me-3 fw-bold text-primary">
                            👋 Hello, @auth.User.Identity?.Name
                        </span>
                        <button class="btn btn-danger btn-sm" @onclick="Logout">Logout</button>
                    </div>
                </Authorized>

                <NotAuthorized>
                    <a href="/login" class="btn btn-outline-primary btn-sm">Login</a>
                </NotAuthorized>
            </AuthorizeView>
        </div>

        <!-- CONTEÚDO -->
        <article class="content px-4 py-3">
            @Body
        </article>
    </main>
</div>

@code {
    private bool isLoggedIn;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        isLoggedIn = authState.User.Identity?.IsAuthenticated ?? false;

        // Atualiza sempre que o login/logout mudar
        AuthStateProvider.AuthenticationStateChanged += OnAuthStateChanged;
    }

    private void OnAuthStateChanged(Task<AuthenticationState> task)
    {
        InvokeAsync(async () =>
        {
            var authState = await task;
            isLoggedIn = authState.User.Identity?.IsAuthenticated ?? false;
            StateHasChanged();
        });
    }

    private async Task Logout()
    {
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "authToken");
        AuthStateProvider.NotifyUserLogout();
        NavigationManager.NavigateTo("/login");
    }
}
